<!DOCTYPE html>
<html>
<head>
    <title>Sohbet Uygulaması (Geçici)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f0f0f0; }
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .form-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        .form-box h2 { margin-top: 0; color: #333; }
        .form-box input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-box button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .form-box a { color: #007bff; text-decoration: none; cursor: pointer; }
        #register-form { display: none; }
        #chat-app-container { display: none; flex-direction: column; height: 100vh; padding: 20px; box-sizing: border-box; }
        #header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #mesajlar { background: white; flex-grow: 1; overflow-y: scroll; padding: 15px; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
        .mesaj { background: #e3f2fd; padding: 8px 12px; margin: 6px 0; border-radius: 15px; max-width: 70%; word-wrap: break-word; }
        .mesaj strong { color: #0d47a1; }
        #input-area { display: flex; }
        #mesajInput { flex-grow: 1; padding: 10px; font-size: 16px; border: 2px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="form-box">
            <div id="login-form">
                <h2>Giriş Yap</h2>
                <input type="email" id="loginEmail" placeholder="E-posta">
                <input type="password" id="loginPassword" placeholder="Şifre">
                <button onclick="loginUser()">GİRİŞ YAP</button>
                <p>Hesabın yok mu? <a onclick="toggleForm()">Kayıt ol</a></p>
            </div>
            <div id="register-form">
                <h2>Kayıt Ol</h2>
                <input type="text" id="registerUsername" placeholder="Kullanıcı Adı">
                <input type="email" id="registerEmail" placeholder="E-posta">
                <input type="password" id="registerPassword" placeholder="Şifre">
                <button onclick="registerUser()">KAYIT OL</button>
                <p>Zaten hesabın var mı? <a onclick="toggleForm()">Giriş yap</a></p>
            </div>
        </div>
    </div>
    
    <div id="chat-app-container">
        <div id="header">
            <h2>Genel Sohbet (Her Dakika Sıfırlanır)</h2>
            <div>
                <span id="username-display" style="margin-right: 15px;"></span>
                <button onclick="logoutUser()" style="background:#f44336; padding: 8px 15px;">ÇIKIŞ YAP</button>
            </div>
        </div>
        <div id="mesajlar"></div>
        <div id="input-area">
            <input id="mesajInput" type="text" placeholder="Mesajını yaz...">
            <button onclick="mesajGonder()" style="margin-left: 10px; padding: 10px 20px;">GÖNDER</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC5XS00Wu02kEVYj5thRuDXl8zhLQrRDR4",
            authDomain: "chatuygulama-cbf18.firebaseapp.com",
            databaseURL: "https://chatuygulama-cbf18-default-rtdb.firebaseio.com",
            projectId: "chatuygulama-cbf18",
            storageBucket: "chatuygulama-cbf18.firebasestorage.app",
            messagingSenderId: "881374423023",
            appId: "1:881374423023:web:8b17a88119d9123295381a",
            measurementId: "G-9FSZXNYLBD"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;

        function toggleForm() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
            registerForm.style.display = registerForm.style.display === 'none' ? 'block' : 'none';
        }

        function registerUser() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!username || !email || !password) { alert("Lütfen tüm alanları doldurun."); return; }
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    database.ref('users/' + userCredential.user.uid).set({
                        username: username,
                        email: email
                    });
                })
                .catch((error) => { alert("Kayıt hatası: " + error.message); });
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => { alert("Giriş hatası: " + error.message); });
        }

        function logoutUser() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            const authContainer = document.getElementById('auth-container');
            const chatContainer = document.getElementById('chat-app-container');
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
                database.ref('/users/' + user.uid).once('value').then((snapshot) => {
                    document.getElementById('username-display').textContent = "Hoş geldin, " + snapshot.val().username;
                });
                loadChatMessages();
            } else {
                currentUser = null;
                authContainer.style.display = 'flex';
                chatContainer.style.display = 'none';
            }
        });

        function mesajGonder() {
            const mesajInput = document.getElementById('mesajInput');
            const mesajMetni = mesajInput.value;
            if (mesajMetni.trim() === '' || !currentUser) return;
            database.ref('/users/' + currentUser.uid).once('value').then((snapshot) => {
                const username = snapshot.val().username;
                database.ref('genel_sohbet').push({
                    uid: currentUser.uid,
                    kullanici: username,
                    metin: mesajMetni,
                    zaman: Date.now()
                });
                mesajInput.value = '';
            });
        }

        function loadChatMessages() {
            const mesajlarDiv = document.getElementById('mesajlar');
            mesajlarDiv.innerHTML = '';
            const chatRef = database.ref('genel_sohbet');
            
            // Yeni mesaj geldiğinde ekrana ekle
            chatRef.on('child_added', (snapshot) => {
                const mesaj = snapshot.val();
                const div = document.createElement('div');
                div.className = 'mesaj';
                div.innerHTML = `<strong>${mesaj.kullanici}:</strong> ${mesaj.metin}`;
                mesajlarDiv.appendChild(div);
                mesajlarDiv.scrollTop = mesajlarDiv.scrollHeight;
            });

            // Bir mesaj silindiğinde (yani hepsi silindiğinde) ekrandan da temizle
            chatRef.on('child_removed', (snapshot) => {
                mesajlarDiv.innerHTML = '';
            });
        }
        
        document.getElementById('mesajInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') mesajGonder();
        });

        // YENİ BÖLÜM: SOHBETİ OTOMATİK TEMİZLEME
        setInterval(function() {
            // Firebase veritabanındaki 'genel_sohbet' alanını sil
            database.ref('genel_sohbet').remove()
                .then(function() {
                    console.log("Sohbet geçmişi otomatik olarak temizlendi.");
                })
                .catch(function(error) {
                    console.log("Temizleme sırasında hata oluştu: " + error.message);
                });
        }, 60000); // 60000 milisaniye = 1 dakika

    </script>
</body>
</html>

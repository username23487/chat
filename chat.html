<!DOCTYPE html>
<html>
<head>
    <title>Sohbet Uygulaması</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f0f0f0; }
        #auth-container { height: 100vh; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        .auth-box h2 { margin-top: 0; }
        .auth-box input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 10px; border: none; border-radius: 4px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
        .auth-box a { color: #007bff; text-decoration: none; cursor: pointer; display: block; margin-top: 15px; }
        #register-form { display: none; }
        #app-container { display: none; height: 100vh; }
        #chat-app-layout { display: flex; height: 100%; }
        #sidebar { width: 250px; background: #333; color: white; padding: 15px; display: flex; flex-direction: column; box-sizing: border-box; }
        #chat-list, #online-users-list { list-style: none; padding: 0; margin: 10px 0; }
        #chat-list { max-height: 40%; overflow-y: auto; }
        #chat-list li, #online-users-list li { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; word-break: break-word; }
        #chat-list li.active { background: #555; }
        #user-info { margin-top: auto; font-size: 12px; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; }
        #chat-title { margin-top: 0; }
        #mesajlar { background: white; flex-grow: 1; overflow-y: scroll; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .mesaj { background: #e3f2fd; padding: 8px 12px; margin: 6px 0; border-radius: 15px; max-width: 70%; display: flex; flex-direction: column; }
        .mesaj strong { color: #0d47a1; }
        .mesaj .timestamp { font-size: 11px; color: #555; align-self: flex-end; margin-top: 4px; }
        #input-area { display: flex; align-items: center; }
        #mesajInput { flex-grow: 1; padding: 10px; font-size: 16px; border-radius: 5px; }
        .online-dot { height: 8px; width: 8px; background-color: #4CAF50; border-radius: 50%; display: inline-block; margin-right: 8px; }
        #online-users-list li { cursor: default; }
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box">
            <div id="login-form">
                <h2>Giriş Yap</h2>
                <input type="email" id="login-email" placeholder="E-posta"><input type="password" id="login-password" placeholder="Şifre"><button onclick="girisYap()">GİRİŞ YAP</button>
                <a onclick="toggleForms()">Hesabın yok mu? Kayıt Ol</a>
                <!-- YENİ: Anonim giriş linki -->
                <a onclick="signInAnonymously()" style="margin-top: 25px; color: #555;">veya Misafir Olarak Devam Et</a>
            </div>
            <div id="register-form">
                <h2>Kayıt Ol</h2>
                <input type="text" id="register-username" placeholder="Kullanıcı Adı"><input type="email" id="register-email" placeholder="E-posta"><input type="password" id="register-password" placeholder="Şifre"><button onclick="kayitOl()">KAYIT OL</button>
                <a onclick="toggleForms()">Zaten hesabın var mı? Giriş Yap</a>
            </div>
        </div>
    </div>
    <div id="app-container">
        <!-- ... (HTML'in geri kalanı aynı) ... -->
    </div>
    <audio id="notification-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-design/ui_loading_screen_generic_progress_tick_002_single.mp3" preload="auto"></audio>
    <!-- Tam HTML'i aşağıya ekliyorum -->
    <div id="app-container">
        <div id="chat-app-layout">
            <div id="sidebar">
                <h3>Sohbetler</h3><ul id="chat-list"></ul>
                <!-- Anonim kullanıcılar için bu butonları gizleyeceğiz -->
                <div id="member-features">
                    <button onclick="startPrivateChat()">Özel Sohbet Başlat</button>
                    <h3 style="margin-top: 20px;">Çevrimiçi</h3><ul id="online-users-list"></ul>
                </div>
                <div id="user-info">
                    <p><strong>Hoş geldin,</strong><br><span id="user-display-name"></span></p>
                    <button onclick="cikisYap()" style="width:100%; margin-top:10px; background: #f44336; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">ÇIKIŞ YAP</button>
                </div>
            </div>
            <div id="main-chat">
                <h2 id="chat-title"></h2>
                <div id="mesajlar"></div>
                <div id="input-area">
                    <input id="mesajInput" type="text" placeholder="Mesajını yaz..."><button onclick="mesajGonder()" style="margin-left:10px; padding:10px 20px; border-radius: 5px; border:none; background:#4CAF50; color:white; cursor:pointer;">GÖNDER</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script>
        // ... (firebaseConfig ve diğer değişkenler aynı) ...
        
        // YENİ: Anonim giriş fonksiyonu
        function signInAnonymously() {
            auth.signInAnonymously().catch(error => {
                alert("Anonim giriş başarısız: " + error.message);
            });
        }
        
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                initChatApp(user.isAnonymous); // YENİ: Kullanıcının anonim olup olmadığını gönder
            } else {
                // ... (çıkış yapma kısmı aynı) ...
            }
        });

        // YENİ: initChatApp fonksiyonu artık anonim kullanıcıları farklı şekilde ele alıyor
        function initChatApp(isAnonymous) {
            const memberFeatures = document.getElementById('member-features');
            
            if (isAnonymous) {
                // Kullanıcı anonim ise
                const randomId = Math.floor(1000 + Math.random() * 9000);
                document.getElementById('user-display-name').textContent = `Misafir-${randomId}`;
                memberFeatures.style.display = 'none'; // Üye özelliklerini gizle
                document.getElementById('chat-list').innerHTML = '';
                addChatToList('public_chat', '# Genel Sohbet');
                loadChat('public_chat', '# Genel Sohbet');
            } else {
                // Kullanıcı kayıtlı üye ise (eski kodumuz)
                memberFeatures.style.display = 'block'; // Üye özelliklerini göster
                database.ref('users/' + currentUser.uid).once('value').then(snapshot => {
                    const username = snapshot.val().username;
                    document.getElementById('user-display-name').textContent = username;
                    setupPresence(currentUser.uid, username);
                });
                document.getElementById('chat-list').innerHTML = '';
                addChatToList('public_chat', '# Genel Sohbet');
                loadUserChats();
                loadChat('public_chat', '# Genel Sohbet');
            }
        }
        
        // YENİ: Mesaj gönderme fonksiyonu anonim kullanıcıları da destekliyor
        function mesajGonder() {
            const mesajInput = document.getElementById('mesajInput');
            const mesaj = mesajInput.value;
            if (mesaj.trim() && currentUser) {
                let username = document.getElementById('user-display-name').textContent; // Ekranda yazan ismi al
                
                database.ref('chats/' + currentChatId).push({
                    username: username,
                    userId: currentUser.uid,
                    metin: mesaj,
                    zaman: Date.now()
                });
                mesajInput.value = '';
            }
        }
        
        // ... (Diğer tüm fonksiyonlar aynı kalacak) ...
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- YENÄ°: Mobil uyumluluk iÃ§in en Ã¶nemli satÄ±r -->
    <title>Sohbet UygulamasÄ±</title>
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f0f0; overflow: hidden; }
        #auth-container { height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .auth-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .auth-box h2 { margin-top: 0; }
        .auth-box input, .auth-box button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .auth-box button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        .auth-box a { color: #007bff; text-decoration: none; cursor: pointer; display: block; margin-top: 15px; }
        #register-form { display: none; }
        #app-container { display: none; height: 100vh; }
        #chat-app-layout { display: flex; height: 100%; position: relative; }
        #sidebar { width: var(--sidebar-width); background: #2f3136; color: #dcddde; padding: 15px; display: flex; flex-direction: column; box-sizing: border-box; transition: transform 0.3s ease-in-out; z-index: 100; }
        #chat-list, #online-users-list { list-style: none; padding: 0; margin: 10px 0; }
        #chat-list li, #online-users-list li { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; word-break: break-word; font-weight: 500; }
        #chat-list li.active { background: #40444b; }
        #user-info { margin-top: auto; font-size: 14px; background: #292b2f; padding: 10px; border-radius: 5px; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; background: #36393f; }
        #chat-header { display: flex; align-items: center; padding: 10px 20px; background: #36393f; box-shadow: 0 1px 0 rgba(0,0,0,0.2); color: white; }
        #menu-toggle { display: none; font-size: 24px; background: none; border: none; color: white; cursor: pointer; margin-right: 15px; }
        #chat-title { margin: 0; font-size: 18px; }
        #mesajlar { flex-grow: 1; overflow-y: scroll; padding: 20px; }
        .mesaj { background: transparent; padding: 2px 0; margin: 10px 0; max-width: 90%; display: flex; flex-direction: column; }
        .mesaj strong { color: #fff; }
        .mesaj .timestamp { font-size: 11px; color: #72767d; }
        .mesaj-header { display: flex; align-items: baseline; }
        .mesaj-content { color: #dcddde; margin-left: 8px; }
        .mesaj img { max-width: 100%; width: 300px; border-radius: 10px; margin-top: 5px; }
        #input-area { display: flex; align-items: center; padding: 20px; background: #40444b; }
        #mesajInput { flex-grow: 1; padding: 12px; font-size: 16px; border-radius: 5px; border: none; background: #484c52; color: #dcddde; }
        #image-upload-label { font-size: 24px; cursor: pointer; padding: 0 15px; color: #b9bbbe; }
        #image-upload-input { display: none; }
        .online-dot { height: 10px; width: 10px; background-color: #43b581; border-radius: 50%; display: inline-block; margin-right: 10px; }
        
        @media screen and (max-width: 768px) {
            #sidebar { position: absolute; top: 0; left: 0; bottom: 0; transform: translateX(-100%); width: 80%; max-width: 300px; }
            #sidebar.open { transform: translateX(0%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            #menu-toggle { display: block; }
        }
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box"><div id="login-form"><h2>GiriÅŸ Yap</h2><input type="email" id="login-email" placeholder="E-posta"><input type="password" id="login-password" placeholder="Åžifre"><button onclick="girisYap()">GÄ°RÄ°Åž YAP</button><a onclick="toggleForms()">HesabÄ±n yok mu? KayÄ±t Ol</a></div><div id="register-form"><h2>KayÄ±t Ol</h2><input type="text" id="register-username" placeholder="KullanÄ±cÄ± AdÄ±"><input type="email" id="register-email" placeholder="E-posta"><input type="password" id="register-password" placeholder="Åžifre"><button onclick="kayitOl()">KAYIT OL</button><a onclick="toggleForms()">Zaten hesabÄ±n var mÄ±? GiriÅŸ Yap</a></div></div>
    </div>
    <div id="app-container">
        <div id="chat-app-layout">
            <div id="sidebar">
                <h3>Sohbetler</h3><ul id="chat-list"></ul><button onclick="startPrivateChat()">Ã–zel Sohbet BaÅŸlat</button><h3 style="margin-top: 20px;">Ã‡evrimiÃ§i</h3><ul id="online-users-list"></ul>
                <div id="user-info">
                    <p><strong>HoÅŸ geldin,</strong><br><span id="user-display-name"></span></p>
                    <button onclick="cikisYap()" style="width:100%; margin-top:10px; background: #f44336; color:white; border:none; padding:8px; font-size:14px; border-radius:5px; cursor:pointer;">Ã‡IKIÅž YAP</button>
                </div>
            </div>
            <div id="main-chat">
                <div id="chat-header"><button id="menu-toggle" onclick="toggleSidebar()">â˜°</button><h2 id="chat-title"></h2></div>
                <div id="mesajlar"></div>
                <div id="input-area">
                    <label for="image-upload-input" id="image-upload-label">ðŸ“Ž</label><input type="file" id="image-upload-input" accept="image/*" onchange="handleImageUpload(event)">
                    <input id="mesajInput" type="text" placeholder="MesajÄ±nÄ± yaz..."><button onclick="mesajGonder()" style="margin-left: 10px; padding: 12px 20px; background: #5865f2; color:white; border:none; border-radius:5px; cursor:pointer;">GÃ–NDER</button>
                </div>
            </div>
        </div>
    </div>
    <audio id="notification-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-design/ui_loading_screen_generic_progress_tick_002_single.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>
    <script>
        // --- Firebase Config (seninkiyle deÄŸiÅŸtir) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC5XS00Wu02kEVYj5thRuDXl8zhLQrRDR4",
            authDomain: "chatuygulama-cbf18.firebaseapp.com",
            databaseURL: "https://chatuygulama-cbf18-default-rtdb.firebaseio.com",
            projectId: "chatuygulama-cbf18",
            storageBucket: "chatuygulama-cbf18.firebasestorage.app",
            messagingSenderId: "881374423023",
            appId: "1:881374423023:web:8b17a88119d9123295381a",
            measurementId: "G-9FSZXNYLBD"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        const sidebar = document.getElementById('sidebar'); // YENÄ°
        const notificationSound = document.getElementById('notification-sound'); const authContainer = document.getElementById('auth-container'); const appContainer = document.getElementById('app-container'); let currentUser = null; let currentChatId = null; let currentChatListener = null;
        
        // YENÄ°: Mobil menÃ¼yÃ¼ aÃ§Ä±p kapatan fonksiyon
        function toggleSidebar() { sidebar.classList.toggle('open'); }
        
        auth.onAuthStateChanged(user => { if (user) { currentUser = user; authContainer.style.display = 'none'; appContainer.style.display = 'block'; initChatApp(); } else { if (currentUser) { database.ref(`status/${currentUser.uid}`).set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP }); } currentUser = null; authContainer.style.display = 'flex'; appContainer.style.display = 'none'; } });
        function kayitOl() { const username = document.getElementById('register-username').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; if (!username) return alert('LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin!'); auth.createUserWithEmailAndPassword(email, password).then(userCredential => { database.ref('users/'' + userCredential.user.uid).set({ username: username, email: email }); }).catch(error => alert('KayÄ±t baÅŸarÄ±sÄ±z: ' + error.message)); }
        function girisYap() { const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => alert('GiriÅŸ baÅŸarÄ±sÄ±z: ' + error.message)); }
        function cikisYap() { auth.signOut(); }
        function toggleForms() { const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form'); if (loginForm.style.display === 'none') { loginForm.style.display = 'block'; registerForm.style.display = 'none'; } else { loginForm.style.display = 'none'; registerForm.style.display = 'block'; } }
        function initChatApp() { database.ref('users/'' + currentUser.uid).once('value').then(snapshot => { const username = snapshot.val().username; document.getElementById('user-display-name').textContent = username; setupPresence(currentUser.uid, username); }); document.getElementById('chat-list').innerHTML = ''; addChatToList('public_chat', '# Genel Sohbet'); loadUserChats(); loadChat('public_chat', '# Genel Sohbet'); }
        function setupPresence(userId, username) { const userStatusRef = database.ref('/status/' + userId); const isOfflineForDatabase = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP, username: username }; const isOnlineForDatabase = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP, username: username }; database.ref('.info/connected').on('value', (snap) => { if (snap.val() === false) return; userStatusRef.onDisconnect().set(isOfflineForDatabase).then(() => { userStatusRef.set(isOnlineForDatabase); }); }); const onlineUsersRef = database.ref('/status').orderByChild('state').equalTo('online'); onlineUsersRef.on('value', (snapshot) => { const onlineUsersList = document.getElementById('online-users-list'); onlineUsersList.innerHTML = ''; snapshot.forEach((childSnapshot) => { const user = childSnapshot.val(); const li = document.createElement('li'); li.innerHTML = `<span class="online-dot"></span> ${user.username}`; onlineUsersList.appendChild(li); }); }); }
        function addChatToList(chatId, chatName) { const chatList = document.getElementById('chat-list'); if (document.querySelector(`li[data-chatid="${chatId}"]`)) return; const li = document.createElement('li'); li.textContent = chatName; li.dataset.chatid = chatId; li.onclick = () => loadChat(chatId, chatName); chatList.appendChild(li); }
        function loadUserChats() { const userChatsRef = database.ref(`users/${currentUser.uid}/chats`); userChatsRef.on('child_added', snapshot => { addChatToList(snapshot.key, `ðŸ”’ ${snapshot.val().withUsername}`); }); }
        function loadChat(chatId, chatName) { if (window.innerWidth <= 768) { toggleSidebar(); } if (currentChatListener) { database.ref('chats/' + currentChatId).off('child_added', currentChatListener); } currentChatId = chatId; const mesajlarDiv = document.getElementById('mesajlar'); mesajlarDiv.innerHTML = ''; document.getElementById('chat-title').textContent = chatName; document.querySelectorAll('#chat-list li').forEach(li => li.classList.remove('active')); const activeLi = document.querySelector(`li[data-chatid="${chatId}"]`); if (activeLi) { activeLi.classList.add('active'); } currentChatListener = database.ref('chats/' + chatId).orderByChild('zaman').on('child_added', (snapshot) => { const mesaj = snapshot.val(); const div = document.createElement('div'); const tarih = new Date(mesaj.zaman); const saat = tarih.getHours().toString().padStart(2, '0'); const dakika = tarih.getMinutes().toString().padStart(2, '0'); const zamanMetni = `${saat}:${dakika}`; let mesajIcerigi = ''; if (mesaj.type === 'image') { mesajIcerigi = `<img src="${mesaj.imageUrl}" alt="YÃ¼klenen resim" style="max-width:100%; border-radius:10px; margin-top:5px;">`; } else { mesajIcerigi = mesaj.metin.replace(/</g, "&lt;").replace(/>/g, "&gt;"); } div.innerHTML = `<div style="display:flex; align-items:baseline;"><strong style="color:#fff;">${mesaj.username}</strong><span style="font-size:11px; color:#72767d; margin-left:8px;">${zamanMetni}</span></div><div style="color:#dcddde;">${mesajIcerigi}</div>`; mesajlarDiv.appendChild(div); mesajlarDiv.scrollTop = mesajlarDiv.scrollHeight; if (mesaj.userId !== currentUser.uid) { notificationSound.play().catch(e => {}); } }); }
        function mesajGonder() { const mesajInput = document.getElementById('mesajInput'); const mesaj = mesajInput.value; if (mesaj.trim() && currentUser) { database.ref('users/'' + currentUser.uid).once('value').then(snapshot => { const username = snapshot.val().username; database.ref('chats/' + currentChatId).push({ username: username, userId: currentUser.uid, metin: mesaj, type: 'text', zaman: Date.now() }); mesajInput.value = ''; }); } }
        function handleImageUpload(event) { const file = event.target.files[0]; if (!file || !currentUser) return; if (!file.type.startsWith('image/')){ alert("LÃ¼tfen sadece resim dosyasÄ± yÃ¼kleyin."); return; } const imageName = `${Date.now()}-${currentUser.uid}-${file.name}`; const storageRef = storage.ref(`chat_images/${imageName}`); const uploadTask = storageRef.put(file); uploadTask.on('state_changed', null, (error) => { alert("Resim yÃ¼klenirken bir hata oluÅŸtu: " + error); }, () => { uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => { database.ref('users/' + currentUser.uid).once('value').then(snapshot => { const username = snapshot.val().username; database.ref('chats/' + currentChatId).push({ username: username, userId: currentUser.uid, imageUrl: downloadURL, type: 'image', zaman: Date.now() }); }); }); }); event.target.value = ''; }
        async function startPrivateChat() { const otherUserEmail = prompt("KonuÅŸmak istediÄŸin kiÅŸinin E-POSTA adresini yaz:"); if (!otherUserEmail || otherUserEmail.toLowerCase() === currentUser.email.toLowerCase()) { alert("GeÃ§ersiz veya kendi e-posta adresinizi girdiniz."); return; } const usersRef = database.ref('users'); const snapshot = await usersRef.orderByChild('email').equalTo(otherUserEmail.toLowerCase()).once('value'); if (!snapshot.exists()) { alert("Bu e-postaya sahip bir kullanÄ±cÄ± bulunamadÄ±!"); return; } const otherUserId = Object.keys(snapshot.val())[0]; const otherUserData = snapshot.val()[otherUserId]; const ids = [currentUser.uid, otherUserId].sort(); const privateChatId = `private-${ids.join('-')}`; const myUsername = (await database.ref(`users/${currentUser.uid}`).once('value')).val().username; await database.ref(`users/${currentUser.uid}/chats/${privateChatId}`).set({ withUsername: otherUserData.username }); await database.ref(`users/${otherUserId}/chats/${privateChatId}`).set({ withUsername: myUsername }); addChatToList(privateChatId, `ðŸ”’ ${otherUserData.username}`); loadChat(privateChatId, `ðŸ”’ ${otherUserData.username}`); }
        document.getElementById('mesajInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') mesajGonder(); });
    </script>
</body>
</html>

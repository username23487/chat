<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sohbet Admin Edition</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #36393f; color: #dcddde; overflow: hidden; }
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-box { background: #36393f; padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); width: 320px; text-align: center; border: 1px solid #222; }
        .auth-box h2 { margin-top: 0; color: #fff; }
        .auth-box input { background: #202225; border: 1px solid #111; color: #dcddde; }
        .auth-box input, .auth-box button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .auth-box button { background: #5865f2; color: white; cursor: pointer; border: none; }
        .auth-box a { color: #00a8fc; text-decoration: none; cursor: pointer; display: block; margin-top: 15px; }
        #register-form { display: none; }
        #app-container { display: none; height: 100vh; }
        #chat-app-layout { display: flex; height: 100%; }
        #sidebar { width: 250px; background: #2f3136; display: flex; flex-direction: column; box-sizing: border-box; }
        #chat-list, #online-users-list { list-style: none; padding: 10px; margin: 0; }
        #online-users-list li { cursor: pointer; }
        #chat-list li, #online-users-list li { padding: 10px; border-radius: 5px; margin-bottom: 2px; word-break: break-word; font-weight: 500; }
        #chat-list li.active, #online-users-list li:hover { background: #40444b; }
        #user-info { margin-top: auto; font-size: 12px; background: #292b2f; padding: 10px; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-header { display:flex; justify-content:space-between; align-items:center; padding: 10px 20px; box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        #mesajlar { flex-grow: 1; overflow-y: scroll; padding: 0 20px; display: flex; flex-direction: column; }
        .mesaj { max-width: 80%; margin-top: 17px; display: flex; flex-direction: column; }
        .mesaj.sent { align-self: flex-end; align-items: flex-end; }
        .mesaj.received { align-self: flex-start; align-items: flex-start; }
        .message-bubble { padding: 8px 12px; border-radius: 15px; line-height: 1.4; max-width: 100%; word-wrap: break-word; }
        .mesaj.sent .message-bubble { background: #5865f2; }
        .mesaj.received .message-bubble { background: #40444b; }
        .mesaj-header { display: flex; align-items: baseline; margin-bottom: 4px; }
        .mesaj strong { color: #fff; font-size: 14px; }
        .mesaj .timestamp { font-size: 11px; color: #72767d; margin-left: 8px; }
        .delete-icon { font-size: 14px; color: #72767d; cursor: pointer; margin-left: 10px; display: none; }
        .mesaj:hover .delete-icon { display: inline; }
        #input-area { display: flex; align-items: center; padding: 20px; background: #2f3136; }
        #mesajInput { flex-grow: 1; padding: 12px; border: none; background: #40444b; color: #dcddde; border-radius: 5px; font-size:16px; }
        .online-dot { height: 10px; width: 10px; background-color: #43b581; border-radius: 50%; display: inline-block; margin-right: 10px; }
        #typing-indicator { height: 20px; padding: 0 20px; font-size: 13px; font-style: italic; color: #72767d; }
        #admin-panel { display: none; background: #202225; padding: 10px; border-radius: 5px; margin-top: 15px; }
        #admin-panel h4 { margin-top: 0; }
        #admin-panel button { width: 100%; padding: 8px; margin-top: 5px; background: #d83c3e; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box"><div id="login-form"><h2>Giri≈ü Yap</h2><input type="email" id="login-email" placeholder="E-posta"><input type="password" id="login-password" placeholder="≈ûifre"><button onclick="girisYap()">Gƒ∞Rƒ∞≈û YAP</button><a onclick="toggleForms()">Hesabƒ±n yok mu? Kayƒ±t Ol</a><a onclick="signInAnonymously()" style="margin-top: 25px; color: #72767d;">veya Misafir Olarak Devam Et</a></div><div id="register-form"><h2>Kayƒ±t Ol</h2><input type="text" id="register-username" placeholder="Kullanƒ±cƒ± Adƒ±"><input type="email" id="register-email" placeholder="E-posta"><input type="password" id="register-password" placeholder="≈ûifre"><button onclick="kayitOl()">KAYIT OL</button><a onclick="toggleForms()">Zaten hesabƒ±n var mƒ±? Giri≈ü Yap</a></div></div>
    </div>
    <div id="app-container">
        <div id="chat-app-layout">
            <div id="sidebar"><h3>Sohbetler</h3><ul id="chat-list"></ul><div id="member-features"><button onclick="startPrivateChat()" style="width:100%;padding:10px;border:none;border-radius:5px;background:#40444b;color:white;cursor:pointer;">√ñzel Sohbet Ba≈ülat</button><h3 style="margin-top: 20px;">√áevrimi√ßi</h3><ul id="online-users-list"></ul></div><div id="admin-panel"><h4>üëë Admin Paneli</h4><button onclick="banUser()">Kullanƒ±cƒ± Yasakla</button><button onclick="clearChatRoom()">Sohbet Odasƒ±nƒ± Temizle</button></div><div id="user-info"><p><strong>Ho≈ü geldin,</strong><br><span id="user-display-name"></span></p><button onclick="cikisYap()" style="width:100%; margin-top:10px; background: #d83c3e; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">√áIKI≈û YAP</button></div></div>
            <div id="main-chat"><div id="chat-header"><h2 id="chat-title"></h2><button onclick="clearChatScreen()" style="background:none; border:none; color:#b9bbbe; cursor:pointer;">Ekranƒ± Temizle</button></div><div id="mesajlar"></div><div id="typing-indicator"></div><div id="input-area"><input id="mesajInput" type="text" placeholder="Mesajƒ±nƒ± yaz..."><button onclick="mesajGonder()" style="margin-left:10px; padding:12px 20px; background:#5865f2; color:white; border:none; border-radius:5px; cursor:pointer;">G√ñNDER</button></div></div>
        </div>
    </div>
    <audio id="notification-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-design/ui_loading_screen_generic_progress_tick_002_single.mp3" preload="auto"></audio>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyC5XS00Wu02kEVYj5thRuDXl8zhLQrRDR4", authDomain: "chatuygulama-cbf18.firebaseapp.com", databaseURL: "https://chatuygulama-cbf18-default-rtdb.firebaseio.com", projectId: "chatuygulama-cbf18", messagingSenderId: "881374423023", appId: "1:881374423023:web:8b17a88119d9123295381a"};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const notificationSound = document.getElementById('notification-sound'); const authContainer = document.getElementById('auth-container'); const appContainer = document.getElementById('app-container'); const mesajInput = document.getElementById('mesajInput'); const typingIndicator = document.getElementById('typing-indicator');
        let currentUser = null; let currentChatId = null; let typingTimeout = null; let isAdmin = false;

        function banUser() { const userIdToBan = prompt("Yasaklamak istediƒüin kullanƒ±cƒ±nƒ±n ID'sini gir:"); if (userIdToBan) { database.ref('bannedUsers/' + userIdToBan).set(true); alert("Kullanƒ±cƒ± mesaj g√∂ndermeye kar≈üƒ± yasaklandƒ±."); } }
        function clearChatRoom() { const chatIdToClear = prompt("Temizlemek istediƒüin sohbet odasƒ±nƒ±n ID'sini gir (√ñrn: public_chat):"); if (chatIdToClear && confirm(`'${chatIdToClear}' odasƒ±ndaki T√úM mesajlarƒ± silmek istediƒüine emin misin?`)) { database.ref('chats/' + chatIdToClear).remove(); alert("Sohbet odasƒ± temizlendi."); } }
        function deleteMessage(chatId, messageKey) { if (confirm("Bu mesajƒ± herkes i√ßin silmek istediƒüine emin misin?")) { database.ref(`chats/${chatId}/${messageKey}`).remove(); } }
        
        // --- BU FONKSƒ∞YON D√úZELTƒ∞LDƒ∞ ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // Giri≈ü yapƒ±lmƒ±≈üsa
                currentUser = user;
                isAdmin = (currentUser.email === 'admin@gmail.com');
                authContainer.style.display = 'none'; // Giri≈ü ekranƒ±nƒ± gizle
                appContainer.style.display = 'block'; // Uygulamayƒ± g√∂ster
                initChatApp(user.isAnonymous);
            } else {
                // √áƒ±kƒ±≈ü yapƒ±lmƒ±≈üsa
                currentUser = null;
                isAdmin = false;
                authContainer.style.display = 'flex'; // Giri≈ü ekranƒ±nƒ± g√∂ster
                appContainer.style.display = 'none'; // Uygulamayƒ± gizle
            }
        });

        function initChatApp(isAnonymous) { document.getElementById('admin-panel').style.display = isAdmin ? 'block' : 'none'; const memberFeatures = document.getElementById('member-features'); document.getElementById('chat-list').innerHTML = ''; addChatToList('public_chat', '# Genel Sohbet'); if (isAnonymous) { const randomId = Math.floor(1000 + Math.random() * 9000); document.getElementById('user-display-name').textContent = `Misafir-${randomId}`; memberFeatures.style.display = 'none'; loadChat('public_chat', '# Genel Sohbet'); } else { memberFeatures.style.display = 'block'; database.ref('users/' + currentUser.uid).once('value').then(snapshot => { const username = snapshot.val().username; document.getElementById('user-display-name').textContent = username; setupPresence(currentUser.uid, username); }); loadUserChats(); loadChat('public_chat', '# Genel Sohbet'); } }
        async function mesajGonder() { if (mesajInput.value.trim() && currentUser) { const bannedSnapshot = await database.ref('bannedUsers/' + currentUser.uid).once('value'); if (bannedSnapshot.exists()) { alert("Yasaklandƒ±ƒüƒ±nƒ±z i√ßin mesaj g√∂nderemezsiniz."); return; } const username = document.getElementById('user-display-name').textContent; database.ref('chats/' + currentChatId).push({ username: username, userId: currentUser.uid, metin: mesajInput.value, zaman: Date.now() }); database.ref(`typing/${currentChatId}/${currentUser.uid}`).remove(); mesajInput.value = ''; } }
        function loadChat(chatId, chatName) { if (currentChatId) { database.ref('chats/' + currentChatId).off(); } currentChatId = chatId; const mesajlarDiv = document.getElementById('mesajlar'); mesajlarDiv.innerHTML = ''; document.getElementById('chat-title').textContent = chatName; document.querySelectorAll('#chat-list li').forEach(li => li.classList.remove('active')); document.querySelector(`li[data-chatid="${chatId}"]`).classList.add('active'); setupTypingIndicator(chatId); const chatRef = database.ref('chats/' + chatId); chatRef.orderByChild('zaman').limitToLast(100).on('child_added', (snapshot) => { const mesaj = snapshot.val(); const messageKey = snapshot.key; const div = document.createElement('div'); div.className = "mesaj " + (mesaj.userId === currentUser.uid ? 'sent' : 'received'); const tarih = new Date(mesaj.zaman); const saat = tarih.getHours().toString().padStart(2, '0'); const dakika = tarih.getMinutes().toString().padStart(2, '0'); const zamanMetni = `${saat}:${dakika}`; let adminDeleteButton = ''; if (isAdmin) { adminDeleteButton = `<span class="delete-icon" onclick="deleteMessage('${chatId}', '${messageKey}')">üóëÔ∏è</span>`; } div.innerHTML = `<div class="mesaj-header"><strong>${mesaj.username}</strong><span class="timestamp">${zamanMetni}</span>${adminDeleteButton}</div><div class="message-bubble">${(mesaj.metin || "").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`; mesajlarDiv.appendChild(div); mesajlarDiv.scrollTop = mesajlarDiv.scrollHeight; }); }
        
        function kayitOl() { const username = document.getElementById('register-username').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; if (!username) return alert('L√ºtfen bir kullanƒ±cƒ± adƒ± girin!'); auth.createUserWithEmailAndPassword(email, password).then(userCredential => { database.ref('users/' + userCredential.user.uid).set({ username: username, email: email }); }).catch(error => alert('Kayƒ±t ba≈üarƒ±sƒ±z: ' + error.message)); }
        function girisYap() { const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => alert('Giri≈ü ba≈üarƒ±sƒ±z: ' + error.message)); }
        function cikisYap() { auth.signOut(); }
        function toggleForms() { const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form'); if (loginForm.style.display === 'none') { loginForm.style.display = 'block'; registerForm.style.display = 'none'; } else { loginForm.style.display = 'none'; registerForm.style.display = 'block'; } }
        function setupPresence(userId, username) { const userStatusRef = database.ref('/status/' + userId); const isOnlineForDatabase = { state: 'online', username: username }; database.ref('.info/connected').on('value', (snap) => { if (snap.val() === false) return; userStatusRef.onDisconnect().set({ state: 'offline', username: username }).then(() => { userStatusRef.set(isOnlineForDatabase); }); }); const onlineUsersRef = database.ref('/status').orderByChild('state').equalTo('online'); onlineUsersRef.on('value', (snapshot) => { const onlineUsersList = document.getElementById('online-users-list'); onlineUsersList.innerHTML = ''; snapshot.forEach((child) => { const user = child.val(); if (user.username) { const li = document.createElement('li'); li.innerHTML = `<span class="online-dot"></span> ${user.username}`; onlineUsersList.appendChild(li); } }); }); }
        mesajInput.addEventListener('input', () => { if (!currentUser || !currentChatId || currentUser.isAnonymous) return; const typingRef = database.ref(`typing/${currentChatId}/${currentUser.uid}`); typingRef.set(document.getElementById('user-display-name').textContent); clearTimeout(typingTimeout); typingTimeout = setTimeout(() => { typingRef.remove(); }, 2000); });
        function setupTypingIndicator(chatId) { if(currentChatId) { database.ref(`typing/${currentChatId}`).off(); } const typingRef = database.ref(`typing/${chatId}`); typingRef.on('value', snapshot => { const typers = snapshot.val(); if (typers) { const typerIds = Object.keys(typers).filter(id => id !== currentUser.uid); if (typerIds.length > 0) { const names = typerIds.map(id => typers[id]).join(', '); typingIndicator.textContent = `${names} yazƒ±yor...`; } else { typingIndicator.textContent = ''; } } else { typingIndicator.textContent = ''; } }); }
        function addChatToList(chatId, chatName) { const li = document.createElement('li'); li.textContent = chatName; li.dataset.chatid = chatId; li.onclick = () => loadChat(chatId, chatName); document.getElementById('chat-list').appendChild(li); }
        function loadUserChats() { const userChatsRef = database.ref(`users/${currentUser.uid}/chats`); userChatsRef.on('child_added', snapshot => { addChatToList(snapshot.key, `üîí ${snapshot.val().withUsername}`); }); }
        function clearChatScreen() { document.getElementById('mesajlar').innerHTML = ''; }
        async function startPrivateChat() { const otherUserId = prompt("Konu≈ümak istediƒüin ki≈üinin KULLANICI ID'sini yaz:"); if (!otherUserId || otherUserId === currentUser.uid) return; const userRef = database.ref('users/' + otherUserId); const snapshot = await userRef.once('value'); if (!snapshot.exists()) return alert("Kullanƒ±cƒ± bulunamadƒ±!"); const otherUserData = snapshot.val(); const ids = [currentUser.uid, otherUserId].sort(); const privateChatId = `private-${ids.join('-')}`; const myUsername = (await database.ref(`users/${currentUser.uid}`).once('value')).val().username; await database.ref(`users/${currentUser.uid}/chats/${privateChatId}`).set({ withUsername: otherUserData.username }); await database.ref(`users/${otherUserId}/chats/${privateChatId}`).set({ withUsername: myUsername }); addChatToList(privateChatId, `üîí ${otherUserData.username}`); loadChat(privateChatId, `üîí ${otherUserData.username}`); }
        document.getElementById('mesajInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') mesajGonder(); });
    </script>
</body>
</html>
